<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Admin - Set Kartu & Histori</title>
<style>
body{
  margin:0;font-family:Inter,Poppins,sans-serif;background:#0b0b0b;color:#eee;display:flex;justify-content:center;padding:20px;
}
.panel{
  width:100%;max-width:1000px;background:#111;padding:20px;border-radius:12px;border:1px solid rgba(212,175,55,0.1);
}
h1{color:#d4af37;margin-bottom:10px;}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;}
.card-editor{padding:10px;border-radius:10px;background:#0f1113;border:1px solid rgba(212,175,55,0.05);}
select{width:100%;padding:8px;border-radius:8px;background:#0b1114;color:#fff;border:none;}
.btn{background:#d4af37;color:#111;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;margin-right:8px;}
.status{margin-top:12px;color:#9aa0a6;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid rgba(212,175,55,0.1);padding:8px;text-align:center;}
th{background:#0f1113;color:#d4af37;}
td{background:#0b0b0b;}
.cards-list{font-size:13px;color:#bfc6c9;}
.nav-btns{margin-top:10px;text-align:center;}
.nav-btns button{margin:0 5px;}
</style>
</head>
<body>
<div class="panel">
<h1>Admin Panel - Set Kartu & Histori</h1>

<label>Kode Akses Admin:</label>
<input type="text" id="codeInput" value="1234"/>

<div class="grid" id="editGrid"></div>

<div style="margin-top:10px;">
<button id="saveBtn" class="btn">Save</button>
<button id="refreshBtn" class="btn">Refresh</button>
</div>
<div class="status" id="status">Status: Idle</div>

<h2 style="margin-top:30px;color:#d4af37;">Histori Kode User</h2>
<table>
  <thead>
    <tr>
      <th>Kode</th>
      <th>Status</th>
      <th>Waktu</th>
      <th>Kartu 1</th>
      <th>Kartu 2</th>
      <th>Kartu 3</th>
      <th>Kartu 4</th>
      <th>Kartu 5</th>
      <th>Kartu 6</th>
      <th>Kartu 7</th>
      <th>Kartu 8</th>
      <th>Kartu 9</th>
    </tr>
  </thead>
  <tbody id="historyBody">
    <!-- data realtime dari Firebase -->
  </tbody>
</table>
<div class="nav-btns">
  <button id="prevBtn" class="btn">Prev</button>
  <span id="pageInfo" style="margin:0 10px;color:#d4af37;">1</span>
  <button id="nextBtn" class="btn">Next</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlpuf_uIlpmr2ybAqpJ2GTTRW-t86PGf0",
  authDomain: "hadiahnatal-a033b.firebaseapp.com",
  databaseURL: "https://hadiahnatal-a033b-default-rtdb.firebaseio.com",
  projectId: "hadiahnatal-a033b",
  storageBucket: "hadiahnatal-a033b.firebasestorage.app",
  messagingSenderId: "577153304596",
  appId: "1:577153304596:web:5f255e886a379ccb12bf01",
  measurementId: "G-C5Q83YQ6SK"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, "gameConfig/cards");
const usedRef = ref(db, "gameConfig/usedCodes");

const editGrid = document.getElementById('editGrid');
const codeInput = document.getElementById('codeInput');
const saveBtn = document.getElementById('saveBtn');
const refreshBtn = document.getElementById('refreshBtn');
const status = document.getElementById('status');
const historyBody = document.getElementById('historyBody');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageInfo = document.getElementById('pageInfo');

const OPTIONS = ["Platinum","Diamond","Super Diamond"];
const ITEMS_PER_PAGE = 10;
let historyData = [];
let currentPage = 1;

function buildGrid(){
  editGrid.innerHTML="";
  for(let i=0;i<9;i++){
    const wrap=document.createElement("div");
    wrap.className="card-editor";
    wrap.innerHTML=`<div>Kartu ${i+1}</div>
    <select data-index="${i}">${OPTIONS.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
    editGrid.appendChild(wrap);
  }
}

function setStatus(txt,ok=true){
  status.textContent="Status: "+txt;
  status.style.color = ok?"#9aa0a6":"#ff6b6b";
}

// render halaman histori
function renderHistoryPage(){
  historyBody.innerHTML="";
  if(historyData.length === 0){
    historyBody.innerHTML="<tr><td colspan='12'>Belum ada histori</td></tr>";
    pageInfo.textContent = "0";
    return;
  }
  const totalPages = Math.ceil(historyData.length / ITEMS_PER_PAGE);
  if(currentPage > totalPages) currentPage = totalPages;
  if(currentPage < 1) currentPage = 1;

  const startIdx = (currentPage-1)*ITEMS_PER_PAGE;
  const pageItems = historyData.slice(startIdx, startIdx + ITEMS_PER_PAGE);

  pageItems.forEach(item=>{
    const tr = document.createElement("tr");

    const tdCode = document.createElement("td");
    tdCode.textContent = item.code;
    tr.appendChild(tdCode);

    const tdStatus = document.createElement("td");
    tdStatus.textContent = item.timestamp ? "Sudah digunakan" : "Belum digunakan";
    tr.appendChild(tdStatus);

    const tdTime = document.createElement("td");
    tdTime.textContent = item.timestamp ? new Date(item.timestamp).toLocaleString('id-ID') : "-";
    tr.appendChild(tdTime);

    const cardsArr = item.cards || [];
    for(let i=0;i<9;i++){
      const td = document.createElement("td");
      td.textContent = cardsArr[i] || "-";
      tr.appendChild(td);
    }
    historyBody.appendChild(tr);
  });

  pageInfo.textContent = `${currentPage} / ${totalPages}`;
}

// load histori realtime
function loadHistory(){
  onValue(usedRef,(snap)=>{
    historyData = [];
    if(snap.exists()){
      const data = snap.val();
      for(const [code,obj] of Object.entries(data)){
        historyData.push({code, cards: obj.cards||[], timestamp: obj.timestamp||null});
      }
      historyData.sort((a,b)=>b.timestamp - a.timestamp);
    }
    renderHistoryPage();
  });
}

buildGrid();
loadHistory();

prevBtn.addEventListener("click",()=>{
  currentPage--;
  renderHistoryPage();
});
nextBtn.addEventListener("click",()=>{
  currentPage++;
  renderHistoryPage();
});
</script>
</body>
</html>
