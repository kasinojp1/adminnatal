<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Admin - Set Kartu & Histori</title>
<style>
body{
  margin:0;font-family:Inter,Poppins,sans-serif;background:#0b0b0b;color:#eee;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px;
}
.panel{
  width:100%;max-width:900px;background:#111;padding:20px;border-radius:12px;border:1px solid rgba(212,175,55,0.1);
}
h1{color:#d4af37;margin-bottom:10px;}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;}
.card-editor{padding:10px;border-radius:10px;background:#0f1113;border:1px solid rgba(212,175,55,0.05);}
select{width:100%;padding:8px;border-radius:8px;background:#0b1114;color:#fff;border:none;}
.btn{background:#d4af37;color:#111;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;margin-right:8px;}
.status{margin-top:12px;color:#9aa0a6;}
.history{
  margin-top:20px;
  background:#111;
  border:1px solid rgba(212,175,55,0.05);
  border-radius:10px;
  padding:12px;
  max-height:300px;
  overflow-y:auto;
}
.history h2{font-size:16px;margin-top:0;color:#d4af37;}
.history ul{list-style:none;padding:0;margin:0;}
.history li{padding:4px 0;border-bottom:1px solid rgba(212,175,55,0.05);}
</style>
</head>
<body>
<div class="panel">
<h1>Admin Panel - Set Kartu</h1>
<label>Kode Akses:</label>
<input type="text" id="codeInput" value="1234"/>

<div class="grid" id="editGrid"></div>

<div style="margin-top:10px;">
<button id="saveBtn" class="btn">Save</button>
<button id="refreshBtn" class="btn">Refresh</button>
</div>
<div class="status" id="status">Status: Idle</div>

<div class="history">
<h2>Histori Kode & Hadiah</h2>
<ul id="historyList">
<!-- Akan diisi dari Firebase -->
</ul>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, set, get, onValue, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlpuf_uIlpmr2ybAqpJ2GTTRW-t86PGf0",
  authDomain: "hadiahnatal-a033b.firebaseapp.com",
  databaseURL: "https://hadiahnatal-a033b-default-rtdb.firebaseio.com",
  projectId: "hadiahnatal-a033b",
  storageBucket: "hadiahnatal-a033b.firebasestorage.app",
  messagingSenderId: "577153304596",
  appId: "1:577153304596:web:5f255e886a379ccb12bf01",
  measurementId: "G-C5Q83YQ6SK"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, "gameConfig/cards");
const usedRef = ref(db, "gameConfig/usedCodes");

const editGrid = document.getElementById('editGrid');
const codeInput = document.getElementById('codeInput');
const saveBtn = document.getElementById('saveBtn');
const refreshBtn = document.getElementById('refreshBtn');
const status = document.getElementById('status');
const historyList = document.getElementById('historyList');

const OPTIONS = ["Platinum","Diamond","Super Diamond"];

function buildGrid(){
  editGrid.innerHTML="";
  for(let i=0;i<9;i++){
    const wrap=document.createElement("div");
    wrap.className="card-editor";
    wrap.innerHTML=`<div>Kartu ${i+1}</div>
    <select data-index="${i}">${OPTIONS.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
    editGrid.appendChild(wrap);
  }
}

function setStatus(txt,ok=true){
  status.textContent="Status: "+txt;
  status.style.color = ok?"#9aa0a6":"#ff6b6b";
}

async function saveToFirebase(){
  setStatus("Menyimpan...");
  const cards = Array.from(editGrid.querySelectorAll("select")).map(s=>s.value);
  const code = codeInput.value || "1234";
  try{
    await set(dbRef,{code,cards});
    setStatus("Tersimpan ✓");
  }catch(err){console.error(err); setStatus("Gagal: "+err.message,false);}
}

async function loadFromFirebase(){
  setStatus("Memuat...");
  try{
    const snap = await get(dbRef);
    if(snap.exists()){
      const data = snap.val();
      codeInput.value = data.code||"1234";
      const cards = data.cards||[];
      Array.from(editGrid.querySelectorAll("select")).forEach((s,i)=>{
        if(cards[i]) s.value = cards[i];
      });
      setStatus("Data dimuat ✓");
    }else{setStatus("Belum ada data");}
  }catch(err){console.error(err); setStatus("Gagal: "+err.message,false);}
}

// realtime update
onValue(dbRef,(snap)=>{
  if(snap.exists()){
    setStatus("Update live dari database");
  }
});

// Histori kode & hadiah
function loadHistory(){
  historyList.innerHTML="";
  onValue(usedRef,(snap)=>{
    if(snap.exists()){
      const data = snap.val();
      historyList.innerHTML="";
      for(const [code,obj] of Object.entries(data)){
        const li = document.createElement("li");
        li.textContent = `Kode: ${code} — Hadiah: ${obj?.prizes ? obj.prizes.join(", ") : "N/A"}`;
        historyList.appendChild(li);
      }
    } else {
      historyList.innerHTML="<li>Belum ada histori</li>";
    }
  });
}

buildGrid();
loadFromFirebase();
loadHistory();

saveBtn.addEventListener("click",saveToFirebase);
refreshBtn.addEventListener("click",loadFromFirebase);
</script>
</body>
</html>
