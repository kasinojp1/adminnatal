<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Admin - Set Kartu & Histori</title>
<style>
body{
  margin:0;font-family:Inter,Poppins,sans-serif;background:#0b0b0b;color:#eee;display:flex;justify-content:center;padding:20px;
}
.panel{
  width:100%;max-width:1200px;background:#111;padding:20px;border-radius:12px;border:1px solid rgba(212,175,55,0.1);
}
h1{color:#d4af37;margin-bottom:10px;}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;}
.card-editor{padding:10px;border-radius:10px;background:#0f1113;border:1px solid rgba(212,175,55,0.05);}
select{width:100%;padding:8px;border-radius:8px;background:#0b1114;color:#fff;border:none;}
.btn{background:#d4af37;color:#111;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;margin-right:8px;}
.status{margin-top:12px;color:#9aa0a6;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid rgba(212,175,55,0.1);padding:6px;text-align:center;font-size:13px;}
th{background:#0f1113;color:#d4af37;}
td{background:#0b0b0b;}
.cards-list{font-size:13px;color:#bfc6c9;}
</style>
</head>
<body>
<div class="panel">
<h1>Admin Panel - Set Kartu & Histori</h1>

<label>Kode Admin:</label>
<input type="text" id="codeInput" placeholder="Masukkan kode baru"/>

<div class="grid" id="editGrid"></div>

<div style="margin-top:10px;">
<button id="saveBtn" class="btn">Save Kode</button>
<button id="refreshBtn" class="btn">Refresh</button>
</div>
<div class="status" id="status">Status: Idle</div>

<h2 style="margin-top:30px;color:#d4af37;">Histori Kode User</h2>
<table>
  <thead>
    <tr>
      <th>Kode</th>
      <th>Status</th>
      <th>Jam Dibuat</th>
      <th>Kartu 1</th>
      <th>Kartu 2</th>
      <th>Kartu 3</th>
      <th>Kartu 4</th>
      <th>Kartu 5</th>
      <th>Kartu 6</th>
      <th>Kartu 7</th>
      <th>Kartu 8</th>
      <th>Kartu 9</th>
    </tr>
  </thead>
  <tbody id="historyBody">
    <tr><td colspan="12">Memuat histori...</td></tr>
  </tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, set, get, onValue, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlpuf_uIlpmr2ybAqpJ2GTTRW-t86PGf0",
  authDomain: "hadiahnatal-a033b.firebaseapp.com",
  databaseURL: "https://hadiahnatal-a033b-default-rtdb.firebaseio.com",
  projectId: "hadiahnatal-a033b",
  storageBucket: "hadiahnatal-a033b.firebasestorage.app",
  messagingSenderId: "577153304596",
  appId: "1:577153304596:web:5f255e886a379ccb12bf01",
  measurementId: "G-C5Q83YQ6SK"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const editGrid = document.getElementById('editGrid');
const codeInput = document.getElementById('codeInput');
const saveBtn = document.getElementById('saveBtn');
const refreshBtn = document.getElementById('refreshBtn');
const status = document.getElementById('status');
const historyBody = document.getElementById('historyBody');

const OPTIONS = ["Platinum","Diamond","Super Diamond"];

function buildGrid(){
  editGrid.innerHTML="";
  for(let i=0;i<9;i++){
    const wrap=document.createElement("div");
    wrap.className="card-editor";
    wrap.innerHTML=`<div>Kartu ${i+1}</div>
    <select data-index="${i}">${OPTIONS.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
    editGrid.appendChild(wrap);
  }
}

function setStatus(txt,ok=true){
  status.textContent="Status: "+txt;
  status.style.color = ok?"#9aa0a6":"#ff6b6b";
}

// Save kode admin + kartu ke Firebase
async function saveToFirebase(){
  const code = codeInput.value.trim();
  if(!code){
    setStatus("Masukkan kode terlebih dahulu", false);
    return;
  }
  const cards = Array.from(editGrid.querySelectorAll("select")).map(s=>s.value);
  const codeRef = ref(db, `gameConfig/cards/${code}`);
  try{
    await set(codeRef, {
      cards,
      createdAt: new Date().toISOString(),
      used: false
    });
    setStatus("Kode tersimpan ✓");
    codeInput.value = "";
  }catch(err){console.error(err); setStatus("Gagal: "+err.message,false);}
}

// Load kode admin + kartu
async function loadFromFirebase(){
  setStatus("Memuat...");
  buildGrid();
  try{
    const cardsSnap = await get(ref(db,"gameConfig/cards"));
    if(cardsSnap.exists()){
      const data = cardsSnap.val();
      // Jika ingin pilih salah satu kode untuk edit
      // di sini kita tidak otomatis ganti grid
      setStatus("Data kode admin dimuat ✓");
    }else{
      setStatus("Belum ada data");
    }
  }catch(err){console.error(err); setStatus("Gagal: "+err.message,false);}
}

// Load histori user
function loadHistory(){
  historyBody.innerHTML="<tr><td colspan='12'>Memuat...</td></tr>";
  onValue(ref(db,"gameConfig/usedCodes"), snap=>{
    historyBody.innerHTML="";
    if(snap.exists()){
      const data = snap.val();
      // urut terbaru di atas
      const entries = Object.entries(data).sort((a,b)=>{
        const t1 = new Date(a[1].createdAt).getTime();
        const t2 = new Date(b[1].createdAt).getTime();
        return t2-t1;
      });
      for(const [code,obj] of entries){
        const tr = document.createElement("tr");
        const tdCode = document.createElement("td");
        tdCode.textContent = code;
        tr.appendChild(tdCode);

        const tdStatus = document.createElement("td");
        tdStatus.textContent = obj.used ? "Sudah digunakan" : "Belum digunakan";
        tr.appendChild(tdStatus);

        const tdTime = document.createElement("td");
        tdTime.textContent = obj.createdAt ? new Date(obj.createdAt).toLocaleString() : "-";
        tr.appendChild(tdTime);

        const cardsArr = obj.cards || [];
        for(let i=0;i<9;i++){
          const td = document.createElement("td");
          td.textContent = cardsArr[i] || "-";
          tr.appendChild(td);
        }
        historyBody.appendChild(tr);
      }
    } else {
      historyBody.innerHTML="<tr><td colspan='12'>Belum ada histori</td></tr>";
    }
  });
}

buildGrid();
loadFromFirebase();
loadHistory();

saveBtn.addEventListener("click",saveToFirebase);
refreshBtn.addEventListener("click",loadFromFirebase);
</script>
</body>
</html>
