<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Admin - Set Kartu & Histori</title>

<style>
body{
  margin:0;font-family:Inter,Poppins,sans-serif;background:#0b0b0b;color:#eee;display:flex;justify-content:center;padding:20px;
}
.panel{
  width:100%;max-width:1100px;background:#111;padding:20px;border-radius:12px;border:1px solid rgba(212,175,55,0.1);
}
h1{color:#d4af37;margin-bottom:10px;}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;}
.card-editor{padding:10px;border-radius:10px;background:#0f1113;border:1px solid rgba(212,175,55,0.05);}
select{width:100%;padding:8px;border-radius:8px;background:#0b1114;color:#fff;border:none;}
.btn{background:#d4af37;color:#111;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;margin-right:8px;}
.status{margin-top:12px;color:#9aa0a6;}

table{width:100%;border-collapse:collapse;margin-top:20px;font-size:14px;}
th,td{border:1px solid rgba(212,175,55,0.1);padding:8px;text-align:center;}
th{background:#0f1113;color:#d4af37;}
td{background:#0b0b0b;color:#fff;}

.used-yes{color:#4caf50;font-weight:600;}
.used-no{color:#ff6b6b;font-weight:600;}

.pagination{
  margin-top:20px;text-align:center;
}
.page-btn{
  background:#222;color:#d4af37;border:1px solid #444;padding:8px 12px;margin:3px;border-radius:6px;cursor:pointer;
}
.page-btn.active{
  background:#d4af37;color:#000;font-weight:700;
}
</style>
</head>
<body>

<div class="panel">
<h1>Admin Panel Kasinojp - Set Kartu & Histori</h1>

<label>Kode Akses Admin:</label>
<input type="text" id="codeInput" value="1234"/>

<div class="grid" id="editGrid"></div>

<div style="margin-top:10px;">
<button id="saveBtn" class="btn">Save</button>
<button id="refreshBtn" class="btn">Refresh</button>
</div>

<div class="status" id="status">Status: Idle</div>

<h2 style="margin-top:30px;color:#d4af37;">Histori Kode User</h2>

<table>
<thead>
<tr>
  <th>Kode</th>
  <th>Kartu 1</th>
  <th>Kartu 2</th>
  <th>Kartu 3</th>
  <th>Kartu 4</th>
  <th>Kartu 5</th>
  <th>Kartu 6</th>
  <th>Kartu 7</th>
  <th>Kartu 8</th>
  <th>Kartu 9</th>
  <th>Waktu</th>
  <th>Status</th>
</tr>
</thead>
<tbody id="historyBody">
  <tr><td colspan="12">Memuat...</td></tr>
</tbody>
</table>

<div id="pagination" class="pagination"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlpuf_uIlpmr2ybAqpJ2GTTRW-t86PGf0",
  authDomain: "hadiahnatal-a033b.firebaseapp.com",
  databaseURL: "https://hadiahnatal-a033b-default-rtdb.firebaseio.com",
  projectId: "hadiahnatal-a033b",
  storageBucket: "hadiahnatal-a033b.firebasestorage.app",
  messagingSenderId: "577153304596",
  appId: "1:577153304596:web:5f255e886a379ccb12bf01",
  measurementId: "G-C5Q83YQ6SK"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const configRef = ref(db, "gameConfig/cards");
const usedRef = ref(db, "gameConfig/usedCodes");

const editGrid = document.getElementById("editGrid");
const codeInput = document.getElementById("codeInput");
const saveBtn = document.getElementById("saveBtn");
const refreshBtn = document.getElementById("refreshBtn");
const historyBody = document.getElementById("historyBody");
const pagination = document.getElementById("pagination");
const status = document.getElementById("status");

const OPTIONS = ["Platinum","Diamond","Super Diamond"];

let historyData = [];
let currentPage = 1;
const perPage = 10;

// membuat 9 kartu
function buildGrid(){
  editGrid.innerHTML="";
  for(let i=0;i<9;i++){
    const wrap=document.createElement("div");
    wrap.className="card-editor";
    wrap.innerHTML=`
      <div>Kartu ${i+1}</div>
      <select data-index="${i}">
        ${OPTIONS.map(o=>`<option value="${o}">${o}</option>`).join('')}
      </select>
    `;
    editGrid.appendChild(wrap);
  }
}

// status
function setStatus(msg, ok=true){
  status.textContent="Status: "+msg;
  status.style.color = ok ? "#9aa0a6" : "#ff6b6b";
}

// simpan kartu ke firebase
async function saveToFirebase(){
  setStatus("Menyimpan...");
  const cards = Array.from(editGrid.querySelectorAll("select")).map(s=>s.value);
  try{
    await set(configRef,{
      code: codeInput.value || "1234",
      cards
    });
    setStatus("Tersimpan ✓");
  }catch(err){
    setStatus("Error: "+err.message,false);
  }
}

// load config kartu
async function loadFromFirebase(){
  setStatus("Memuat...");
  try{
    const snap = await get(configRef);
    if(snap.exists()){
      const data = snap.val();
      codeInput.value = data.code || "1234";
      const cards = data.cards || [];
      Array.from(editGrid.querySelectorAll("select")).forEach((elm,i)=>{
        if(cards[i]) elm.value = cards[i];
      });
      setStatus("Data dimuat ✓");
    }
  }catch(err){ setStatus("Error: "+err.message,false); }
}

// render pagination
function renderPagination(){
  pagination.innerHTML="";
  const totalPages = Math.ceil(historyData.length / perPage);
  if(totalPages <= 1) return;

  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement("button");
    btn.textContent = "Bagian "+i;
    btn.className="page-btn"+(i===currentPage?" active":"");
    btn.onclick=()=>{ currentPage=i; renderTable(); renderPagination(); };
    pagination.appendChild(btn);
  }
}

// render tabel histori
function renderTable(){
  historyBody.innerHTML="";
  if(historyData.length===0){
    historyBody.innerHTML="<tr><td colspan='12'>Belum ada histori</td></tr>";
    return;
  }

  const start = (currentPage-1)*perPage;
  const pageData = historyData.slice(start, start+perPage);

  pageData.forEach(([code,obj])=>{
    const tr=document.createElement("tr");
    tr.innerHTML+=`<td>${code}</td>`;

    const cards = obj.cards || [];
    for(let i=0;i<9;i++){
      tr.innerHTML+=`<td>${cards[i]||"-"}</td>`;
    }

    tr.innerHTML+=`
      <td>${obj.time ? new Date(obj.time).toLocaleString() : "-"}</td>
      <td class="${obj.used ? 'used-yes':'used-no'}">
        ${obj.used ? 'Sudah digunakan' : 'Belum digunakan'}
      </td>
    `;

    historyBody.appendChild(tr);
  });
}

// load histori dari firebase
onValue(usedRef,(snap)=>{
  if(!snap.exists()){
    historyData=[];
    renderTable();
    renderPagination();
    return;
  }

  // convert ke array dan sort terbaru → atas
  historyData = Object.entries(snap.val()).sort((a,b)=> b[1].time - a[1].time);

  currentPage = 1;

  renderTable();
  renderPagination();
});

// init
buildGrid();
loadFromFirebase();

saveBtn.addEventListener("click",saveToFirebase);
refreshBtn.addEventListener("click",loadFromFirebase);
</script>
</body>
</html>
